<!doctype html>
<html lang="en-gb" class="no-js">
<!--<![endif]-->

<head>
	<title>{{ club['name'] }}</title>

	<meta charset="utf-8">
	<meta name="keywords" content="" />
	<meta name="description" content="" />
	<!-- this styles only adds some repairs on idevices  -->
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />

  <!-- Favicon -->
	<link rel="shortcut icon" href="images/favicon.ico">
  <link rel="stylesheet" href="{{ static_url('weui/lib/weui.css') }}">
  <!-- forms -->
  <link rel="stylesheet" href="{{ static_url('elos/js/form/sky-forms.css') }}" type="text/css" media="all">
	<!-- ######### CSS STYLES ######### -->
	<link rel="stylesheet" href="{{ static_url('elos/css/reset.css') }}" type="text/css" />
	<link rel="stylesheet" href="{{ static_url('elos/css/style.css') }}" type="text/css" />
	<link rel="stylesheet" href="{{ static_url('elos/css/font-awesome/css/font-awesome.min.css') }}">

	<!-- responsive devices styles -->
	<link rel="stylesheet" media="screen" href="{{ static_url('elos/css/responsive-leyouts.css') }}" type="text/css" />
	<!-- mega menu -->
	<link href="{{ static_url('elos/js/mainmenu/sticky.css') }}" rel="stylesheet">
	<link href="{{ static_url('elos/js/mainmenu/bootstrap.css') }}" rel="stylesheet">
	<link href="{{ static_url('elos/js/mainmenu/fhmm.css') }}" rel="stylesheet">

	<!-- cubeportfolio -->
	<link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/cubeportfolio/cubeportfolio.min.css') }}">
	<!-- tabs -->
	<link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/tabs/assets/css/responsive-tabs3.css') }}">
  <link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/tabs/tabwidget/tabwidget.css') }}" />
	<!-- carousel -->
	<link rel="stylesheet" href="{{ static_url('elos/js/carousel/flexslider.css') }}" type="text/css" media="screen" />
	<link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/carousel/skin.css') }}" />
	<!-- progressbar -->
  <link rel="stylesheet" href="js/progressbar/ui.progress-bar.css">
	<!-- accordion -->
	<link rel="stylesheet" href="{{ static_url('elos/js/accordion/accordion.css') }}" type="text/css" media="all">
	<!-- Lightbox -->
	<link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/lightbox/jquery.fancybox.css') }}" media="screen" />
  <link rel="stylesheet" href="{{ static_url('css/self.css') }}">
	<script src="{{ static_url('elos/js/style-switcher/jquery-1.js') }}"></script>

	<link rel="stylesheet" href="{{ static_url('froala/css/froala_editor.min.css') }}">
	<link rel="stylesheet" href="{{ static_url('froala/css/froala_style.min.css') }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.4.0/css/font-awesome.min.css">
	<link rel="stylesheet" href="{{ static_url('froala/css/plugins/code_view.css') }}">
	<link rel="stylesheet" href="{{ static_url('froala/css/plugins/image.css') }}">
	<link rel="stylesheet" href="{{ static_url('froala/css/plugins/video.css') }}">
	<link rel="stylesheet" href="{{ static_url('froala/css/plugins/table.css') }}">
	<link rel="stylesheet" href="{{ static_url('froala/css/plugins/fullscreen.css') }}">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.3.0/codemirror.min.css">


</head>

<body>


	<div class="wrapper_boxed">

		<div class="site_wrapper">
			<!-- top header bar -->
			{% module Template("elos/block-header.html", club=club, categories=categories, is_login=is_login) %}
			<!-- /top header bar -->

			<div class="clearfix"></div>

			<div class="page_title2">
				<div class="container">

					<div class="title">
						<h1>Blog Edit</h1></div>

					<div class="pagenation">&nbsp;<a href="/elos/clubs/{{ club['_id'] }}/blogs">首页</a> <i>/</i> <a href="#">发布博客</a></div>

				</div>
			</div>
			<!-- end page title -->


			<div class="clearfix"></div>

			<div class="container">

				<div class="content_left">
						<div class="cforms">
              <!-- uploading toast -->
              <div id="loadingToast" class="weui_loading_toast" style="display:none;">
                  <div class="weui_mask_transparent"></div>
                  <div class="weui_toast">
                      <div class="weui_loading">
                          <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                      </div>
                      <p class="weui_toast_content">图片上传中...</p>
                  </div>
              </div>
							<form action="#" method="post" id="sky-form" class="sky-form">
								<header>编辑 <strong>文章</strong></header>
								<fieldset>
									<section>
										<label class="label">文章标题</label>
										<label class="input"> <i class="icon-append icon-tag"></i>
                			<input type="text" name="title" id="title" value="{{ article['title'] }}">
              			</label>
									</section>
									<section>
										<label class="label">副标题</label>
										<label class="textarea"> <i class="icon-append icon-comment"></i>
              			  <textarea rows="4" name="subtitle" id="subtitle">{{ article['subtitle'] }}</textarea>
            			  </label>
									</section>
                  <section>
										<label class="label">封面图片</label>
                        <div class="form-group">
                          <div class="rst-account-img" style="position:static;">
                            <img id="article_img" name="article_img" src="{{ article['img'] }}" alt="俱乐部背景图" />
                            <input type="hidden" name="article_img" id="i_article_img">
                            <a class="elos-loadbutton" type="button" onclick="openBrowse('file1')">上传封面图</a>
                            <input type="file" id="file1" name="file1" style="display:none;">
                          </div>
                        </div>
                          <small style="color:red;">图片大小：500px * 300px 1M内 </small>
									</section>
                  <section>
										<label class="label">文章内容</label>
                      <div id='edit' style="margin-top:30px;">{% raw article['paragraphs'] %}</div>
                      <input type="hidden" name="paragraphs" id="paragraphs">
									</section>
								</fieldset>
								<footer>
                  <div class="post_info_content">
                    <div class="clearfix divider_dashed9"></div>
                    <div id="buttons">
                      <ul class="list_empty">
                        <li><a id="init2" href="#" class="but_ok_2"><i class="fa fa-pencil fa-lg"></i> 编辑</a></li>
                        <li><a id="destroy2" href="#" class="but_wifi"><i class="fa fa-cloud-upload fa-lg"></i> 保存</a></li>
                      </ul>
                    </div>
                  </div>
								</footer>
							</form>

						</div>
					<!-- /# end post -->
				</div>
				<!-- end content left side -->

				<!-- right sidebar starts -->
				<div class="right_sidebar">

					<div class="site-search-area">

						<form method="get" id="site-searchform" action="blog.html">
							<div>
								<input class="input-text" name="s" id="s" value="Enter Search keywords..." onFocus="if (this.value == 'Enter Search keywords...') {this.value = '';}" onBlur="if (this.value == '') {this.value = 'Enter Search keywords...';}" type="text" />
								<input id="searchsubmit" value="Search" type="submit" />
							</div>
						</form>

					</div>
					<!-- end site search -->

					<div class="clearfix margin_top4"></div>

					<!-- sidebar category widget -->
					{% module Template("elos/block-sidebar-category.html", categories=categories, club=club) %}
					<!-- /sidebar category widget -->

					<div class="clearfix margin_top4"></div>

					<!-- sidebar popular widget -->
					{% module Template("elos/block-sidebar-popular.html", populars=populars, articles=articles) %}
					<!-- /sidebar popular widget -->

				</div>
				<!-- end right sidebar -->

			</div>

			<div class="clearfix margin_top7"></div>

			<!-- footer -->
			{% module Template("elos/block-footer.html", club=club, categories=categories, articles=articles) %}
			<!-- footer -->

			<div class="clearfix"></div>

			<!-- copyright -->
			{% module Template("elos/block-copyright.html") %}
			<!-- copyright -->

			<a href="#" class="scrollup">Scroll</a>
			<!-- end scroll to top of the page-->

		</div>
	</div>

	<script src="{{ static_url('elos/js/style-switcher/styleselector.js') }}"></script>
	<!-- SLIDER REVOLUTION 4.x SCRIPTS  -->
	<script type="text/javascript" src="{{ static_url('elos/js/revolutionslider/rs-plugin/js/jquery.themepunch.plugins.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('elos/js/revolutionslider/rs-plugin/js/jquery.themepunch.revolution.min.js') }}"></script>
	<!-- mega menu -->
	<script src="{{ static_url('elos/js/mainmenu/bootstrap.min.js') }}"></script>
	<script src="{{ static_url('elos/js/mainmenu/fhmm.js') }}"></script>
	<!-- jquery jcarousel -->
	<script type="text/javascript" src="{{ static_url('elos/js/carousel/jquery.jcarousel.min.js') }}"></script>
	<!-- scroll up -->
	<script src="{{ static_url('elos/js/scrolltotop/totop.js') }}" type="text/javascript"></script>
	<!-- tabs -->
	<script src="{{ static_url('elos/js/tabs/assets/js/responsive-tabs.min.js') }}" type="text/javascript"></script>

	<!-- jquery jcarousel -->
	<script type="text/javascript">
		jQuery(document).ready(function() {
			jQuery('#mycarouselthree').jcarousel();
		});
	</script>

	<!-- accordion -->
	<script type="text/javascript" src="{{ static_url('elos/js/accordion/custom.js') }}"></script>
	<!-- REVOLUTION SLIDER -->
	<script type="text/javascript" src="{{ static_url('elos/js/revolutionslider/rs-plugin/js/custom.js') }}"></script>
	<!-- sticky menu -->
	<script type="text/javascript" src="{{ static_url('elos/js/mainmenu/sticky.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('elos/js/mainmenu/modernizr.custom.75180.js') }}"></script>

	<!-- progress bar -->
	<script src="{{ static_url('elos/js/progressbar/progress.js') }}" type="text/javascript" charset="utf-8"></script>

	<!-- cubeportfolio -->
	<script type="text/javascript" src="{{ static_url('elos/js/cubeportfolio/jquery.cubeportfolio.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('elos/js/cubeportfolio/main.js') }}"></script>
	<!-- carousel -->
	<script defer src="{{ static_url('elos/js/carousel/jquery.flexslider.js') }}"></script>
	<script defer src="{{ static_url('elos/js/carousel/custom.js') }}"></script>
	<!-- lightbox -->
	<script type="text/javascript" src="{{ static_url('elos/js/lightbox/jquery.fancybox.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('elos/js/lightbox/custom.js') }}"></script>
	<!-- fileinput -->
	<script src="{{ static_url('upyun/js/fileinput.min.js') }}"></script>
	<script src="{{ static_url('upyun/js/spark-md5.min.js') }}"></script>
	<script src="{{ static_url('upyun/js/async.js') }}"></script>
	<script src="{{ static_url('upyun/js/upyun-mu.js') }}"></script>
	<script src="{{ static_url('weui/js/weui.js') }}"></script>
	<script type="text/javascript">
		// Menu drop down effect
		$('.dropdown-toggle').dropdownHover().dropdown();
		$(document).on('click', '.fhmm .dropdown-menu', function(e) {
			e.stopPropagation()
		})
	</script>
<!--
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.3.0/codemirror.min.js"></script>
	<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.3.0/mode/xml/xml.min.js"></script> -->
	<script type="text/javascript" src="{{ static_url('froala/js/froala_editor.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/code_beautifier.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/code_view.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/draggable.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/font_size.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/fullscreen.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/align.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/font_family.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/paragraph_style.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/lists.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/image.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/link.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/video.min.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('froala/js/plugins/table.min.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('froala/js/languages/zh_cn.js') }}"></script>

	<input type="file" id="file" name="file" style="display:none;">

	<script>
      function openBrowse(id){
          var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
          if(ie){
              document.getElementById(id).click();
              document.getElementById("filename").value=document.getElementById(id).value;
          }else{
              var a=document.createEvent("MouseEvents");//FF的处理
              a.initEvent("click", true, true);
              document.getElementById(id).dispatchEvent(a);
          }
      };

  $(function() {

    $("#file1").on("change",function(){

        var times = 0;
        var imgUrl = uploadUpyun(this.files[0],"file1");
        $('#loadingToast').show();
        document.addEventListener('uploaded',function(e){
          if(times == 0){
            $("#article_img").attr('src',imgUrl);
            $("#i_article_img").val(imgUrl);
            $('#loadingToast').hide();
          }
          times ++;
        });
    });

        var vFroalaEditor;
    	  function uuid() {
    	    var s = [];
    	    var hexDigits = "0123456789abcdef";
    	    for (var i = 0; i < 36; i++) {
    	      s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    	    }
    	    s[14] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
    	    s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01
    	    s[8] = s[13] = s[18] = s[23] = "-";

    	    var uuid = s.join("");
    	    return uuid;
    	  }

    	  function uploadUpyun(file, elementId) {
    	    var ext = '.' + file.name.split('.').pop();

    	    var config = {
    	      // 空间名称
    	      bucket: 'tripc2c-club-title',
    	      // 上传请求过期时间
    	      expiration: parseInt((new Date().getTime() + 3600000) / 1000),
    	      // 尽量不要使用直接传表单 API 的方式，以防泄露造成安全隐患
    	      form_api_secret: 'CRKAOsKHGbbCnU+yztBxUT0bYR0='
    	    };

    	    var instance = new Sand(config);
    	    var options = {
    	      'notify_url': 'http://upyun.com'
    	    };
    	    instance.setOptions(options);
    	    instance.setElementId(elementId);

    	    var d = new Date();
    	    var month = d.getMonth() + 1;
    	    var filename = '/avatar/' + d.getFullYear() + '/' + month + '/' + d.getDate() + '/' + uuid() + ext;
    	    console.log(filename);
    	    instance.upload(filename);

    	    return 'https://tripc2c-club-title.b0.upaiyun.com' + filename;
    	  };

    	  $("#file").on("change",function(){
    	      var times = 0;
    	      var imgUrl = uploadUpyun(this.files[0],"file");
    	      $('#loadingToast').show();
    	      document.addEventListener('uploaded',function(e){
    	        if(times == 0){
    						var html = '<img src="'+ imgUrl +'" alt="" />';
    						vFroalaEditor.insert(html);
    	          $('#loadingToast').hide();
    	        }
    	        times ++;
    	      });

    	  });

		 $.FroalaEditor.PLUGINS.customPlugin = function (editor) {

			 function openBrowse () {
				 var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
         if(ie){
             document.getElementById("file").click();
             document.getElementById("filename").value=document.getElementById("file").value;
         }else{
             var a=document.createEvent("MouseEvents");//FF的处理
             a.initEvent("click", true, true);
             document.getElementById("file").dispatchEvent(a);
         }
			 };
 		    // Methods visible outside the plugin.
 		    return {
 		      openBrowse: openBrowse
 		    }

		 };

			$.FroalaEditor.DefineIcon('insert', {
				NAME: 'plus'
			});
			$.FroalaEditor.RegisterCommand('insert', {
				title: 'Insert Code',
				focus: true,
				undo: true,
				refreshAfterCallback: true,
				callback: function() {
					var html = '<pre class="brush: js; ruler: true; first-line: 1; highlight: [1, 3, 5]">Insert your code here</pre>';
					console.log(this == $.FroalaEditor.RegisterCommand);
					this.html.insert(html);
				}
			});

			$.FroalaEditor.DefineIcon('imageInfo', {NAME: 'image'});
      $.FroalaEditor.RegisterCommand('imageInfo', {
        title: '插入图片',
        focus: false,
        undo: false,
        refreshAfterCallback: false,
        callback: function () {
					vFroalaEditor = this.html;
					this.customPlugin.openBrowse();
        }
      });

			$('#edit').froalaEditor(
				{
					enter: $.FroalaEditor.ENTER_DIV,
          heightMin:500,
					heightMax: 500,
          language: 'zh_cn',
					toolbarButtons: ['fontFamily', 'bold', 'italic', 'underline', 'strikeThrough', 'fontSize', 'subscript', 'superscript',
						'|', 'color', 'emoticons', 'paragraphFormat', 'paragraphStyle',
						'|', 'align', 'formatOL', 'formatUL', 'outdent', 'indent',
						'|', 'insertLink', 'insertTable', 'insertHR',
						'|', 'undo', 'redo', 'clearFormatting', 'html',
						'|', 'insert','imageInfo'
					],
					toolbarButtonsMD: ['bold', 'italic', 'underline', 'strikeThrough', 'fontFamily', 'fontSize',
						'|', 'color', 'emoticons', 'paragraphFormat', 'paragraphStyle',
						'|', 'align', 'formatOL', 'formatUL', 'outdent', 'indent',
						'|', 'insertLink', 'insertHR',
						'|', 'undo', 'redo', 'html',
						'|', 'insert','imageInfo'
					],
					toolbarButtonsSM: ['bold', 'italic', 'underline', 'fontFamily', 'fontSize',
						'|', 'color', 'paragraphFormat', 'align', 'formatOL', 'formatUL',
						'|', 'insertLink',
						'|', 'undo', 'redo', 'html',
						'|', 'insert','imageInfo'
					],
					toolbarButtonsXS: ['bold', 'fontSize',
						'|', 'align', 'formatOL', 'formatUL',
						'|', 'insert','imageInfo'
					],
				}
			);
			$('#init2').on('click', function(e) {
        e.preventDefault();
				console.log("Initializing Froala Editor...");
				$('#edit').removeClass('fr-view').froalaEditor();
			});
			$('#destroy2').on('click', function(e) {
        e.preventDefault();
        var title = $("#title").val();
        var subtitle = $("#subtitle").val();
        var img = $("#i_article_img").val();
				var html = $('#edit').froalaEditor('html.get');
        $("#paragraphs").val(html);
				console.log(html);
        var data = {
          "title": title,
          "subtitle": subtitle,
          "img": img,
          "paragraphs": html,
        };
        var json = JSON.stringify(data);
        console.log(json);
        $.ajax({
          type: "PUT",
          url: "{{ API_DOMAIN }}/api/articles/{{ article['_id'] }}",
          data: json,
          dataType: "json",
          contentType: 'application/json',
          headers: {"Authorization":"Bearer {{access_token}}"},
          success: function(data, status, xhr) {
              weui.Loading.success();
          },
          error: function(XMLHttpRequest, textStatus, errorThrown) {
            console.log("XMLHttpRequest.status:" + XMLHttpRequest.status);
            $('.lostpwd-form-main-message').addClass('show error').html(XMLHttpRequest.status + ": 服务器异常,请稍后重试!");
          },
          complete: function(XMLHttpRequest, textStatus) {
            this; // 调用本次AJAX请求时传递的options参数
          }
        });
				console.log("Destroying Froala Editor...");
				$('#edit').froalaEditor('destroy');
				$('#edit').addClass('fr-view');
			});

		});

	</script>


</body>

</html>
