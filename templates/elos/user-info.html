<!doctype <html></html>
<html lang="en-gb" class="no-js">
<!--<![endif]-->

<head>
	<title>{{ club['name'] }}</title>

	<meta charset="utf-8">
	<meta name="keywords" content="" />
	<meta name="description" content="" />

	<!-- Favicon -->
	<link rel="shortcut icon" href="images/favicon.ico">

	<!-- this styles only adds some repairs on idevices  -->
	<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=1" />
  <link rel="stylesheet" href="{{ static_url('weui/lib/weui.css') }}">
  <!-- ######### CSS STYLES ######### -->
	<link rel="stylesheet" href="{{ static_url('elos/css/reset.css') }}" type="text/css" />
	<link rel="stylesheet" href="{{ static_url('elos/css/style.css') }}" type="text/css" />
	<link rel="stylesheet" href="{{ static_url('elos/css/font-awesome/css/font-awesome.min.css') }}">
	<!-- responsive devices styles -->
	<link rel="stylesheet" media="screen" href="{{ static_url('elos/css/responsive-leyouts.css') }}" type="text/css" />
	<!-- mega menu -->
	<link href="{{ static_url('elos/js/mainmenu/sticky.css') }}" rel="stylesheet">
	<link href="{{ static_url('elos/js/mainmenu/bootstrap.css') }}" rel="stylesheet">
	<link href="{{ static_url('elos/js/mainmenu/fhmm.css') }}" rel="stylesheet">
	<!-- forms -->
	<link rel="stylesheet" href="{{ static_url('elos/js/form/sky-forms.css') }}" type="text/css" media="all">
	<!-- Lightbox -->
	<link rel="stylesheet" type="text/css" href="{{ static_url('elos/js/lightbox/jquery.fancybox.css') }}" media="screen" />
  <link rel="stylesheet" href="{{ static_url('css/self.css') }}">
	<script src="{{ static_url('elos/js/style-switcher/jquery-1.js') }}"></script>
</head>

<body>


  <div class="wrapper_boxed">

		<div class="site_wrapper">

			<!-- top header bar -->
			{% module Template("elos/block-header.html", club=club, categories=categories, is_login=is_login) %}
			<!-- /top header bar -->

			<div class="clearfix"></div>
			<div class="page_title2">
				<div class="container">

					<div class="title">
						<h1>User</h1></div>

					<div class="pagenation">&nbsp;<a href="/elos/clubs/{{ club['_id'] }}/blogs">首页</a><i>/</i> <a href="#">我的</a>  <i>/</i> <a href="#">个人信息</a></div>

				</div>
			</div>
			<!-- end page title -->


			<div class="clearfix"></div>

			<div class="container">

				<div class="content_fullwidth">

					<div class="one_half">

						<div class="cforms">
              <!-- uploading toast -->
              <div id="loadingToast" class="weui_loading_toast" style="display:none;">
                  <div class="weui_mask_transparent"></div>
                  <div class="weui_toast">
                      <div class="weui_loading">
                          <div class="weui_loading_leaf weui_loading_leaf_0"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_1"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_2"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_3"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_4"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_5"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_6"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_7"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_8"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_9"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_10"></div>
                          <div class="weui_loading_leaf weui_loading_leaf_11"></div>
                      </div>
                      <p class="weui_toast_content">图片上传中...</p>
                  </div>
              </div>
							<form action="#" method="post" id="sky-form" class="sky-form">
								<header>Uesr <strong>Edit</strong></header>
								<fieldset>
									<div class="row">
										<section class="col col-6" style="width:30%;">
											<label class="label">昵称</label>
											<label class="input"> <i class="icon-append icon-user"></i>
                			  <input type="text" name="name" id="name" value="{{ user['nickname'] }}">
                			</label>
										</section>
									</div>
									<section>
										<label class="label">头像</label>
                    <div class="form-group">
                      <div class="rst-account-img" style="position:static;">
                        <img id="user_img" name="user_img" src="{{ user['avatar'] }}" alt="头像" />
                        <a class="elos-loadbutton" type="button" onclick="openBrowse()">上传头像</a>
                        <input type="file" id="file" name="file" style="display:none;">
                      </div>
                    </div>
                      <small style="color:red;">图片大小：80px * 80px 1M内 </small>
									</section>
								</fieldset>
								<footer>
									<button type="submit" class="button">保存</button>
								</footer>
								<div class="message"> <i class="icon-ok"></i>
									<p>Your message was successfully sent!</p>
								</div>
							</form>

						</div>

					</div>
				</div>

			</div>

			<div class="clearfix margin_top7"></div>

			<!-- footer -->
			{% module Template("elos/block-footer.html", club=club, categories=categories, articles=articles) %}
			<!-- footer -->

			<div class="clearfix"></div>

			<!-- copyright -->
			{% module Template("elos/block-copyright.html") %}
			<!-- copyright -->

			<a href="#" class="scrollup">Scroll</a>
			<!-- end scroll to top of the page-->

		</div>
	</div>

  <script src="{{ static_url('elos/js/style-switcher/styleselector.js') }}"></script>
  <!-- mega menu -->
  <script src="{{ static_url('elos/js/mainmenu/bootstrap.min.js') }}"></script>
  <script src="{{ static_url('elos/js/mainmenu/fhmm.js') }}"></script>
  <!-- scroll up -->
  <script src="{{ static_url('elos/js/scrolltotop/totop.js') }}" type="text/javascript"></script>
  <!-- sticky menu -->
  <script type="text/javascript" src="{{ static_url('elos/js/mainmenu/sticky.js') }}"></script>
  <script type="text/javascript" src="{{ static_url('elos/js/mainmenu/modernizr.custom.75180.js') }}"></script>

  <script src="{{ static_url('elos/js/form/jquery.form.min.js') }}"></script>
  <script src="{{ static_url('elos/js/form/jquery.validate.min.js') }}"></script>
  <script src="{{ static_url('elos/js/form/jquery.modal.js') }}"></script>
  <!-- lightbox -->
	<script type="text/javascript" src="{{ static_url('elos/js/lightbox/jquery.fancybox.js') }}"></script>
	<script type="text/javascript" src="{{ static_url('elos/js/lightbox/custom.js') }}"></script>
	<!-- fileinput -->
	<script src="{{ static_url('upyun/js/fileinput.min.js') }}"></script>
	<script src="{{ static_url('upyun/js/spark-md5.min.js') }}"></script>
	<script src="{{ static_url('upyun/js/async.js') }}"></script>
	<script src="{{ static_url('upyun/js/upyun-mu.js') }}"></script>
  <script src="{{ static_url('weui/js/weui.js') }}"></script>
	<script type="text/javascript">
		// Menu drop down effect
		$('.dropdown-toggle').dropdownHover().dropdown();
		$(document).on('click', '.fhmm .dropdown-menu', function(e) {
			e.stopPropagation()
		})
	</script>

  <script type="text/javascript">

    function openBrowse(){
        var ie=navigator.appName=="Microsoft Internet Explorer" ? true : false;
        if(ie){
            document.getElementById("file").click();
            document.getElementById("filename").value=document.getElementById("file").value;
        }else{
            var a=document.createEvent("MouseEvents");//FF的处理
            a.initEvent("click", true, true);
            document.getElementById("file").dispatchEvent(a);
        }
    };

	  function uuid() {
	    var s = [];
	    var hexDigits = "0123456789abcdef";
	    for (var i = 0; i < 36; i++) {
	      s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
	    }
	    s[14] = "4"; // bits 12-15 of the time_hi_and_version field to 0010
	    s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1); // bits 6-7 of the clock_seq_hi_and_reserved to 01
	    s[8] = s[13] = s[18] = s[23] = "-";

	    var uuid = s.join("");
	    return uuid;
	  }

	  function uploadUpyun(file, elementId) {
	    var ext = '.' + file.name.split('.').pop();

	    var config = {
	      // 空间名称
	      bucket: 'tripc2c-club-title',
	      // 上传请求过期时间
	      expiration: parseInt((new Date().getTime() + 3600000) / 1000),
	      // 尽量不要使用直接传表单 API 的方式，以防泄露造成安全隐患
	      form_api_secret: 'CRKAOsKHGbbCnU+yztBxUT0bYR0='
	    };

	    var instance = new Sand(config);
	    var options = {
	      'notify_url': 'http://upyun.com'
	    };
	    instance.setOptions(options);
	    instance.setElementId(elementId);

	    var d = new Date();
	    var month = d.getMonth() + 1;
	    var filename = '/avatar/' + d.getFullYear() + '/' + month + '/' + d.getDate() + '/' + uuid() + ext;
	    console.log(filename);
	    instance.upload(filename);

	    return 'https://tripc2c-club-title.b0.upaiyun.com' + filename;
	  };

	  $("#file").on("change",function(){
	      var times = 0;
	      var imgUrl = uploadUpyun(this.files[0],"file");
	      $('#loadingToast').show();
	      document.addEventListener('uploaded',function(e){
	        if(times == 0){
						$("#user_img").attr('src',imgUrl);
	          $('#loadingToast').hide();
	        }
	        times ++;
	      });

	  });

    $(function() {
			// Validation
			$("#sky-form").validate({
				// Rules for form validation
				rules: {
					name: {
						required: true
					},
					image: {
						required: true,
					},
				},
				// Messages for form validation
				messages: {
					name: {
						required: '请输入一个昵称',
					},
					email: {
						required: '请上传符合格式的头像图片'
					},
				},

				// Ajax form submition
				submitHandler: function(form) {
					weui.alert("123")
            var data = { nickname:$("#name").val(),
                         avatar:$("#user_img").attr('src'),
                       };
            var json = JSON.stringify(data);
            console.log(json);

            $.ajax({
              url:'http://7x24hs.com/api/myinfo',
              type:'PUT',
              data:json,
              dataType: "json",
              headers: {"Authorization":"Bearer {{access_token}}"},
              contentType: 'application/json',
              success: function(data, status, xhr) {
                weui.Loading.success();
              },
              error:function(){
              }

            });
				},

				// Do not change code below
				errorPlacement: function(error, element) {
					error.insertAfter(element.parent());
				}
			});
		});
	</script>

</body>

</html>
